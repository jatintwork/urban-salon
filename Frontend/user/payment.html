<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Urban Salon - Payment</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
  <style>
    .address-card { 
      border: 1px solid #eee; 
      border-radius: 8px; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      background: #fff;
    }
    .address-selected { 
      border: 2px solid #0d6efd; 
      background: #e3f0ff; 
    }
    .payment-method-card { 
      border: 1px solid #eee; 
      border-radius: 8px; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      cursor: pointer; 
      transition: border 0.2s; 
      background: #fff;
    }
    .payment-method-selected { 
      border: 2px solid #0d6efd; 
      background: #e3f0ff; 
    }
    .cart-summary { 
      border: 1px solid #eee; 
      border-radius: 8px; 
      padding: 1rem; 
      background: #fafbfc; 
    }
    .service-item {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fff;
    }
    .service-price {
      font-size: 1.2rem;
      font-weight: bold;
      color: #28a745;
    }
    .mobile-friendly {
      padding: 1rem;
    }
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      .mobile-friendly {
        padding: 0.5rem;
      }
      .cart-summary {
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <div class="container py-4 mobile-friendly">
    <h2 class="mb-4 text-center">Checkout & Payment</h2>
    <div class="row">
      <div class="col-lg-7 mb-4">
        <h4 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Service Address</h4>
        <div class="service-item">
          <div class="mb-3">
            <label for="service-address" class="form-label">Service Address</label>
            <textarea class="form-control" id="service-address" rows="3" placeholder="Enter your service address"></textarea>
          </div>
        </div>

        <h4 class="mb-3 mt-4"><i class="fas fa-calendar me-2"></i>Appointment Date & Time</h4>
        <div class="service-item">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="appointment-date" class="form-label">Preferred Date</label>
              <input type="date" class="form-control" id="appointment-date" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="appointment-time" class="form-label">Preferred Time</label>
              <select class="form-control" id="appointment-time" required>
                <option value="">Select Time</option>
              </select>
            </div>
          </div>
        </div>

        <h4 class="mb-3 mt-4"><i class="fas fa-credit-card me-2"></i>Payment Method</h4>
        <div id="payment-methods">
          <div class="payment-method-card" data-method="cod" onclick="selectPaymentMethod('cod')">
            <input type="radio" name="payment-method" id="pm-cod" class="form-check-input me-2" value="cod"> 
            <label for="pm-cod"><i class="fas fa-money-bill-wave me-2"></i>Cash on Delivery</label>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="cart-summary mb-4">
          <h5><i class="fas fa-shopping-cart me-2"></i>Order Summary</h5>
          <div id="cart-summary-items"></div>
          <div class="d-flex justify-content-between mt-3">
            <span class="fw-bold">Total</span>
            <span class="fw-bold" id="cart-summary-total"></span>
          </div>
        </div>
        <button class="btn btn-primary w-100 btn-lg" id="pay-now-btn">
          <i class="fas fa-lock me-2"></i>Proceed to Payment
        </button>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>
  
  <script>
    fetch('navbar.html').then(r=>r.text()).then(d=>{document.getElementById('navbar-placeholder').innerHTML=d;});
    fetch('footer.html').then(r=>r.text()).then(d=>{document.getElementById('footer-placeholder').innerHTML=d;});

    // Get user address from localStorage
    function loadUserAddress() {
      const userData = localStorage.getItem('urbanSalonUser') || sessionStorage.getItem('urbanSalonUser');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          const addressField = document.getElementById('service-address');
          if (addressField && user.address) {
            addressField.value = user.address;
          }
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }
    }

    // Setup date and time validation
    function setupDateTimeValidation() {
      const dateInput = document.getElementById('appointment-date');
      const timeInput = document.getElementById('appointment-time');

      if (dateInput) {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;

        // Add change event listener for date validation
        dateInput.addEventListener('change', function() {
          validateDateTime();
        });
      }

      if (timeInput) {
        // Generate 24-hour time options
        generateTimeOptions();
        
        // Add change event listener for time validation
        timeInput.addEventListener('change', function() {
          validateDateTime();
        });
      }
    }

    // Generate 24-hour time options
    function generateTimeOptions() {
      const timeSelect = document.getElementById('appointment-time');
      if (!timeSelect) return;

      // Clear existing options
      timeSelect.innerHTML = '<option value="">Select Time</option>';

      // Generate time slots from 00:00 to 23:00 (24-hour format)
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) { // 30-minute intervals
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          const displayTime = formatTimeForDisplay(timeString);
          
          const option = document.createElement('option');
          option.value = timeString;
          option.textContent = displayTime;
          timeSelect.appendChild(option);
        }
      }
    }

    // Format time for display (12-hour format)
    function formatTimeForDisplay(timeString) {
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    // Validate date and time selection
    function validateDateTime() {
      const dateInput = document.getElementById('appointment-date');
      const timeInput = document.getElementById('appointment-time');
      
      if (!dateInput || !timeInput) return;

      const selectedDate = dateInput.value;
      const selectedTime = timeInput.value;

      if (selectedDate && selectedTime) {
        const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
        const now = new Date();

        // Check if selected date/time is in the past
        if (selectedDateTime <= now) {
          alert('Please select a future date and time.');
          timeInput.value = '';
          return false;
        }

        // Check if selected date is today and time is in the past
        const today = new Date().toISOString().split('T')[0];
        if (selectedDate === today) {
          const currentTime = new Date().toTimeString().slice(0, 5);
          if (selectedTime <= currentTime) {
            alert('Please select a future time for today.');
            timeInput.value = '';
            return false;
          }
        }
      }

      return true;
    }

    // Payment method logic
    let selectedPayment = null;
    function selectPaymentMethod(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-method-card').forEach(card=>{
        card.classList.remove('payment-method-selected');
        if(card.getAttribute('data-method')===method) card.classList.add('payment-method-selected');
      });
      document.getElementById('pm-'+method).checked = true;
    }

    // Cart summary
    let cart = JSON.parse(localStorage.getItem('urbanSalonCart')||'[]');
    let selectedServiceId = null; // Store the selected service ID
    
    function renderCartSummary() {
      const itemsDiv = document.getElementById('cart-summary-items');
      let total = 0;
      let html = '';
      cart.forEach(item => {
        total += item.price * item.qty;
        html += `<div class='d-flex justify-content-between mb-2'>
          <span>${item.name} x${item.qty}</span>
          <span>₹${item.price*item.qty}</span>
        </div>`;
      });
      document.getElementById('cart-summary-total').textContent = `₹${total}`;
      itemsDiv.innerHTML = html;
    }

    // Get selected service ID from cart
    function getSelectedServiceId() {
      if (cart.length > 0) {
        return cart[0].id; // Return the first service ID from cart
      }
      return null;
    }

    // Create nested payload for multiple services
    function createNestedPayload() {
      const appointmentDate = document.getElementById('appointment-date').value;
      const appointmentTime = document.getElementById('appointment-time').value;
      const scheduledDateTime = `${appointmentDate}T${appointmentTime}:00`;
      const address = document.getElementById('service-address').value.trim();
      const userData = JSON.parse(localStorage.getItem('urbanSalonUser') || sessionStorage.getItem('urbanSalonUser'));

      // Get the stored selected service ID
      const selectedServiceId = localStorage.getItem('selectedServiceId');

      // Create service requests array
      const serviceRequests = [];
      cart.forEach(item => {
        serviceRequests.push({
          sub_service_id: item.id, // Use the service ID from cart item
          scheduled_datetime: scheduledDateTime,
          location: address,
          email: userData.email
        });
      });

      return {
        service_requests: serviceRequests,
        bulk_create_flag: true
      };
    }

    // Book appointment API call
    async function bookAppointment() {
      const address = document.getElementById('service-address').value.trim();
      const appointmentDate = document.getElementById('appointment-date').value;
      const appointmentTime = document.getElementById('appointment-time').value;
      
      if (!address) {
        alert('Please enter your service address.');
        return;
      }
      if (!appointmentDate) {
        alert('Please select an appointment date.');
        return;
      }
      if (!appointmentTime) {
        alert('Please select an appointment time.');
        return;
      }
      if (!selectedPayment) {
        alert('Please select a payment method.');
        return;
      }
      if (cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }

      // Validate date and time
      if (!validateDateTime()) {
        return;
      }

      // Get user data
      const userData = JSON.parse(localStorage.getItem('urbanSalonUser') || sessionStorage.getItem('urbanSalonUser'));
      if (!userData) {
        alert('Please log in to proceed.');
        window.location.href = 'login.html';
        return;
      }

      // Create nested payload
      const bookingData = createNestedPayload();

      try {
        const response = await fetch('http://127.0.0.1:7002/services/create-service-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userData.access_token}`
          },
          body: JSON.stringify(bookingData)
        });

        if (response.ok) {
          const result = await response.json();
          alert('Order placed successfully!\nPayment method: ' + selectedPayment + '\nAddress: ' + address);
          // Clear cart
          localStorage.removeItem('urbanSalonCart');
          window.location.href = 'index.html';
        } else {
          const errorData = await response.json();
          alert('Failed to place order: ' + (errorData.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error booking appointment:', error);
        alert('An error occurred while placing your order.');
      }
    }

    // Pay Now button
    document.getElementById('pay-now-btn').onclick = bookAppointment;

    // On load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserAddress();
      setupDateTimeValidation();
      renderCartSummary();
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Template Javascript -->
  <script src="js/main.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/notifications.js"></script>

  <!-- Navbar Include Script -->
  <script>
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar-placeholder').innerHTML = data;
        // Trigger auth check after navbar is loaded
        if (typeof checkUserAuthentication === 'function') {
          checkUserAuthentication();
        }
      });
  </script>

  <!-- Footer Include Script -->
  <script>
    fetch('footer.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('footer-placeholder').innerHTML = data;
      });
  </script>
</body>
</html> 